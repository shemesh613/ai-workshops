<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×—×“×¨ 2 â€” ×§×¨×™×¢×ª ×™× ×¡×•×£</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* â”€â”€ Location Input â”€â”€ */
    .location-section { margin: 15px 0; text-align: center; }
    .location-wrapper { display: flex; gap: 8px; justify-content: center; direction: rtl; margin-top: 10px; }
    .location-input {
      padding: 10px 16px; font-size: 1rem; font-family: inherit; text-align: center;
      background: rgba(255,255,255,0.08); border: 1px solid rgba(0,191,255,0.3);
      border-radius: 10px; color: #fff; outline: none; width: 220px; transition: all 0.3s;
    }
    .location-input:focus { border-color: #00bfff; box-shadow: 0 0 15px rgba(0,191,255,0.2); }
    .location-input.wrong { border-color: #ff4444; animation: inputShake 0.5s; }
    .location-input.correct { border-color: #00ff64; box-shadow: 0 0 20px rgba(0,255,100,0.3); }
    @keyframes inputShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); } 40% { transform: translateX(8px); }
      60% { transform: translateX(-5px); } 80% { transform: translateX(5px); }
    }
    .location-btn {
      padding: 10px 20px; font-family: 'Secular One', sans-serif;
      background: rgba(0,191,255,0.15); border: 1px solid rgba(0,191,255,0.4);
      border-radius: 10px; color: #00bfff; cursor: pointer; transition: all 0.3s;
    }
    .location-btn:hover { background: rgba(0,191,255,0.3); }
    .location-feedback {
      margin-top: 10px; font-size: 0.9rem; color: rgba(0,191,255,0.7); min-height: 1.5em;
    }

    /* â”€â”€ Sea Canvas â”€â”€ */
    .sea-scene { margin: 15px 0; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,191,255,0.2); }
    .sea-scene canvas { width: 100%; display: block; }
    .sea-label { text-align: center; padding: 8px; font-size: 0.8rem; color: rgba(0,191,255,0.5); background: rgba(0,20,60,0.5); }

    /* â”€â”€ Drag & Drop Fragments â”€â”€ */
    .drag-section { display: none; margin: 15px 0; }
    .drag-section.unlocked { display: block; animation: scrollReveal 0.8s ease-out; }

    .drop-zones {
      display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;
      margin: 10px 0; direction: rtl;
    }
    .drop-zone {
      width: 100px; height: 50px; border: 2px dashed rgba(0,191,255,0.3);
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      font-family: 'Frank Ruhl Libre', serif; font-size: 0.8rem;
      color: rgba(255,255,255,0.3); transition: all 0.3s; background: rgba(0,30,60,0.2);
    }
    .drop-zone.drag-over { border-color: rgba(255,215,0,0.6); background: rgba(255,215,0,0.08); }
    .drop-zone.filled {
      border-style: solid; border-color: rgba(255,215,0,0.5);
      color: #ffd700; font-weight: bold; background: rgba(50,50,0,0.2);
    }
    .drop-zone.filled.highlight-slot { color: #ff8844; font-size: 1rem; text-shadow: 0 0 10px rgba(255,136,68,0.5); }

    .drag-pieces {
      display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 12px 0;
    }
    .drag-piece {
      padding: 10px 14px; border-radius: 10px; cursor: grab;
      background: rgba(0,50,100,0.2); border: 2px solid rgba(0,191,255,0.25);
      color: rgba(255,255,255,0.7); font-family: 'Frank Ruhl Libre', serif;
      font-size: 0.85rem; transition: all 0.3s; user-select: none;
    }
    .drag-piece:hover { background: rgba(0,100,200,0.25); border-color: rgba(0,191,255,0.5); transform: translateY(-2px); }
    .drag-piece.dragging { opacity: 0.4; cursor: grabbing; }
    .drag-piece.placed { display: none; }
    .drag-piece.fake-piece { /* looks identical â€” player doesn't know */ }

    /* â”€â”€ Hard Question â”€â”€ */
    .hard-question {
      margin: 15px 0; padding: 18px; border-radius: 12px;
      border: 1px solid rgba(0,191,255,0.2); background: rgba(0,30,60,0.2);
      display: none; text-align: center;
    }
    .hard-question.unlocked { display: block; animation: scrollReveal 0.8s ease-out; }
    .hq-text { font-size: 1.05rem; color: #fff; margin-bottom: 12px; line-height: 1.6; }
    .hq-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 10px 0; }
    .hq-option {
      padding: 12px; border-radius: 10px; cursor: pointer;
      background: rgba(0,191,255,0.05); border: 2px solid rgba(0,191,255,0.15);
      color: rgba(255,255,255,0.7); font-size: 0.9rem; transition: all 0.3s;
      font-family: 'Frank Ruhl Libre', serif;
    }
    .hq-option:hover:not(.picked) { background: rgba(0,191,255,0.12); border-color: rgba(0,191,255,0.35); transform: translateY(-2px); }
    .hq-option.picked { pointer-events: none; }
    .hq-option.correct-pick { border-color: rgba(0,255,100,0.5) !important; background: rgba(0,100,0,0.2) !important; color: #00ff88; }
    .hq-option.wrong-pick { border-color: rgba(255,50,50,0.5) !important; background: rgba(100,0,0,0.2) !important; color: #ff6666; opacity: 0.5; }

    .screen-shake { animation: screenShake 0.6s ease-out; }
    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      10% { transform: translateX(-8px); } 20% { transform: translateX(8px); }
      30% { transform: translateX(-6px); } 40% { transform: translateX(6px); }
    }
    @keyframes scrollReveal { from { opacity:0; transform:scaleY(0.3); } to { opacity:1; transform:scaleY(1); } }

    @media (max-width: 600px) {
      .drop-zone { width: 75px; height: 42px; font-size: 0.65rem; }
      .drag-piece { padding: 8px 10px; font-size: 0.75rem; }
      .hq-options { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="theme-sea">
  <video class="video-bg" autoplay muted loop playsinline
    poster="https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=1920&q=80">
    <source src="https://cdn.coverr.co/videos/coverr-waves-crashing-on-rocks-2764/1080p.mp4" type="video/mp4">
  </video>
  <div class="fog-overlay"></div>
  <div class="dark-overlay"></div>
  <canvas id="particles-canvas"></canvas>

  <div class="timer-bar">
    <span class="room-indicator">ğŸŒŠ ×—×“×¨ 2 â€” ×§×¨×™×¢×ª ×™× ×¡×•×£</span>
    <span class="timer-display" id="timer-display">00:00</span>
  </div>

  <div class="room-container">
    <div class="room-icon">ğŸŒŠ</div>
    <h1 class="room-title">×§×¨×™×¢×ª ×™× ×¡×•×£</h1>
    <p class="room-subtitle">×”×™× ×¡×•×¢×¨. ×¤×¨×¢×” ×¨×•×“×£. ××¦× ××ª ×”××§×•× â€” ×•×¤×¢× ×— ××ª ×”×¤×¡×•×§.</p>

    <div class="question-box">
      <p class="question-text">×›××” ×¨×›×‘ ×‘×—×•×¨ ×œ×§×— ×¤×¨×¢×” ×œ×¨×“×•×£ ××—×¨×™ ×‘× ×™ ×™×©×¨××œ?</p>
      <p style="font-size: 0.85rem; color: rgba(0,191,255,0.5); margin-top: 8px;">
        ğŸ—ºï¸ ×©×œ×‘ 1: ××¦× ×‘××¤×” ××™×¤×” ×—× ×• ×™×©×¨××œ ×œ×¤× ×™ ×—×¦×™×™×ª ×”×™×. ×©×œ×‘ 2: ×¡×“×¨ ××ª ×”×¤×¡×•×§. ×©×œ×‘ 3: ×¢× ×” × ×›×•×Ÿ.
      </p>
    </div>

    <!-- â•â•â• PHASE 1: Google Maps + Location Input â•â•â• -->
    <div class="map-container">
      <iframe src="https://maps.google.com/maps?q=29.5,32.5&t=k&z=8&output=embed&hl=he"
        loading="lazy" allowfullscreen style="height: 220px;"></iframe>
      <div class="map-caption">ğŸ“ ××¤×ª ×¡×™× ×™ â€” ×”×™×›×Ÿ ×—× ×• ×‘× ×™ ×™×©×¨××œ ×œ×¤× ×™ ×©× ×§×¨×¢ ×”×™×?</div>
    </div>

    <div class="location-section">
      <p style="font-size: 0.9rem; color: rgba(0,191,255,0.6);">ğŸ“ ×”×§×œ×“ ××ª ×©× ×”××§×•×:</p>
      <div class="location-wrapper">
        <input type="text" class="location-input" id="location-input" placeholder="×©× ×”××§×•×..." autocomplete="off">
        <button class="location-btn" id="location-btn" onclick="checkLocation()">ğŸ” ×‘×“×•×§</button>
      </div>
      <div class="location-feedback" id="location-feedback"></div>
    </div>

    <!-- Sea Canvas -->
    <div class="sea-scene">
      <canvas id="sea-canvas"></canvas>
      <div class="sea-label" id="sea-label">ğŸŒŠ ×”×™× ×¡×•×¢×¨... ××¦× ××ª ×”××§×•× ×›×“×™ ×œ×¤×ª×•×— ××ª ×”×“×¨×š</div>
    </div>

    <!-- â•â•â• PHASE 2: Drag & Drop Verse Assembly â•â•â• -->
    <div class="drag-section" id="drag-section">
      <p style="font-size:0.9rem; color:rgba(0,191,255,0.6); text-align:center; margin-bottom:8px;">
        ğŸ“œ ×¡×“×¨ ××ª ×§×˜×¢×™ ×”×¤×¡×•×§ ×‘×’×¨×™×¨×” ×œ××§×•× ×”× ×›×•×Ÿ:
      </p>
      <p style="font-size:0.75rem; color:rgba(255,100,100,0.5); text-align:center; margin-bottom:10px;">
        âš ï¸ ×™×© ×’× ×§×˜×¢×™× ××–×•×™×¤×™× â€” ×”×™×–×”×¨!
      </p>

      <div class="drop-zones" id="drop-zones">
        <div class="drop-zone" data-slot="0">1</div>
        <div class="drop-zone" data-slot="1">2</div>
        <div class="drop-zone" data-slot="2">3</div>
        <div class="drop-zone" data-slot="3">4</div>
        <div class="drop-zone" data-slot="4">5</div>
      </div>

      <div class="drag-pieces" id="drag-pieces">
        <!-- Filled by JS â€” shuffled real + fake pieces -->
      </div>

      <div style="text-align:center; font-size:0.8rem; color:rgba(0,191,255,0.4); margin:8px 0;">
        ×¡×•×“×¨×• <span id="placed-count" style="color:rgba(0,191,255,0.7);">0</span> ××ª×•×š 5 ×§×˜×¢×™×
      </div>
    </div>

    <!-- â•â•â• PHASE 3: Hard Question â•â•â• -->
    <div class="hard-question" id="hard-question">
      <p style="color:#00bfff; font-size:0.85rem; margin-bottom:8px;">âš¡ ×©××œ×ª ×‘×•× ×•×¡ â€” ×¨××ª ×—×™×“×•×Ÿ ×”×ª× "×š:</p>
      <p class="hq-text">××” ×©× ×”××§×•× ×‘×• ×˜×‘×¢ ×¦×‘× ×¤×¨×¢×”?</p>
      <p style="font-size:0.75rem; color:rgba(255,255,255,0.35); margin-bottom:10px;">×¨××–: "×•Ö·×™Ö¸Ö¼×©Ö¸××‘ ×”Ö·×™Ö¸Ö¼×... ×•Ö·×™Ö°× Ö·×¢Öµ×¨ ×”' ×Ö¶×ª ×Ö´×¦Ö°×¨Ö·×™Ö´× ×‘Ö°Ö¼×ª×•Ö¹×šÖ° ×”Ö·×™Ö¸Ö¼×" â€” ×©××•×ª ×™"×“:×›"×–</p>
      <div class="hq-options">
        <div class="hq-option" onclick="answerHQ(this, false)">××“×‘×¨ ×©×•×¨</div>
        <div class="hq-option" onclick="answerHQ(this, true)">×™× ×¡×•×£</div>
        <div class="hq-option" onclick="answerHQ(this, false)">× ×—×œ ××¦×¨×™×</div>
        <div class="hq-option" onclick="answerHQ(this, false)">××™ ××¨×™×‘×”</div>
      </div>
    </div>

    <!-- Sefaria -->
    <a href="https://www.sefaria.org/Exodus.14.7?lang=he" target="_blank" class="sefaria-link" style="margin:5px auto; display:inline-flex;">
      ğŸ“– ×©××•×ª ×™"×“:×–' â€” ×¡×¤×¨×™×
    </a>

    <div class="password-section">
      <div class="password-wrapper">
        <input type="text" class="password-input" placeholder="×›××” ×¨×›×‘?..." inputmode="numeric" autocomplete="off">
        <button class="submit-btn">ğŸ”“ ×¤×ª×—</button>
      </div>
      <div class="attempts-display"></div>
      <div class="hint-box">ğŸ’¡ ××¦× ××ª ×”××§×•× ×‘××¤×” â† ×¡×“×¨ ××ª ×”×¤×¡×•×§ ×‘×’×¨×™×¨×” â† ×¢× ×” ×¢×œ ×©××œ×ª ×”×‘×•× ×•×¡.</div>
      <div class="hint-box strong">ğŸ”¥ ×©×© ×××•×ª. ×›××” ×–×” ×‘×¡×¤×¨×•×ª?</div>
    </div>
  </div>

  <div class="red-flash"></div>
  <div class="success-overlay">
    <div class="success-message">ğŸŒŠ ×”×™× × ×§×¨×¢!</div>
    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px; font-size: 1.1rem;">×¢×‘×¨×ª ×‘×ª×•×š ×”×™× ×‘×™×‘×©×”. ××‘×œ ×”×¨ ×¡×™× ×™ ××—×›×”.</p>
    <a href="room3.html" class="next-room-btn">â†’ ××œ ×”×¨ ×¡×™× ×™ â›°ï¸</a>
  </div>

  <script src="particles.js"></script>
  <script src="game.js"></script>
  <script>
    if (!checkRoomAccess(2)) throw 'Access denied';
    new ParticleEngine('particles-canvas', 'water');
    const timer = new GameTimer();
    const checker = new PasswordChecker('room2', 'room3.html');

    let locationFound = false;
    let seaSplit = false, splitProgress = 0;
    let placedCount = 0, phase3Done = false;

    // â•â•â• PHASE 1: Location Challenge â•â•â•
    const correctLocations = ['×¤×™ ×”×—×™×¨×•×ª', '×¤×™ ×”×—×™×¨×ª', '×¤×™-×”×—×™×¨×•×ª', 'pi hahiroth', 'pi-hahiroth'];
    const nearLocations = ['××ª×', '××’×“×•×œ', '×‘×¢×œ ×¦×¤×•×Ÿ', '×¡×•×›×•×ª', 'etham', 'migdol'];

    document.getElementById('location-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkLocation();
    });

    function checkLocation() {
      if (locationFound) return;
      const input = document.getElementById('location-input');
      const feedback = document.getElementById('location-feedback');
      const val = input.value.trim().toLowerCase().replace(/['"×´×³]/g, '');
      if (!val) return;

      if (correctLocations.some(loc => val.includes(loc) || loc.includes(val))) {
        locationFound = true;
        input.classList.add('correct');
        input.disabled = true;
        feedback.style.color = '#00ff88';
        feedback.textContent = 'âœ… × ×›×•×Ÿ! ×¤×™ ×”×—×™×¨×•×ª â€” ×©× ×—× ×• ×‘× ×™ ×™×©×¨××œ ×œ×¤× ×™ ×—×¦×™×™×ª ×”×™×!';
        seaSplit = true;
        document.getElementById('sea-label').textContent = 'âœ¨ ×”×™× × ×¤×ª×—! ×¢×›×©×™×• ×¡×“×¨ ××ª ×”×¤×¡×•×§';
        setTimeout(() => document.getElementById('drag-section').classList.add('unlocked'), 800);
      } else if (nearLocations.some(loc => val.includes(loc) || loc.includes(val))) {
        input.classList.add('wrong');
        feedback.style.color = '#ffaa00';
        feedback.textContent = 'ğŸŸ¡ ×§×¨×•×‘! ××‘×œ ×‘× ×™ ×™×©×¨××œ ×—× ×• ×‘××§×•× ×¡×¤×¦×™×¤×™ "×œ×¤× ×™" ××§×•× ××—×¨. ×—×¤×© ×‘×©××•×ª ×™"×“:×‘\'';
        setTimeout(() => { input.classList.remove('wrong'); input.value = ''; }, 2000);
      } else {
        input.classList.add('wrong');
        feedback.style.color = '#ff6666';
        feedback.textContent = 'âŒ ×œ×. ×—×¤×© ×‘×©××•×ª ×™"×“:×‘\' â€” "×“Ö·Ö¼×‘ÖµÖ¼×¨ ×Ö¶×œ ×‘Ö°Ö¼× Öµ×™ ×™Ö´×©Ö°×‚×¨Ö¸×Öµ×œ ×•Ö°×™Ö¸×©Ö»××‘×•Ö¼ ×•Ö°×™Ö·×—Ö²× ×•Ö¼ ×œÖ´×¤Ö°× Öµ×™..."';
        document.body.classList.add('screen-shake');
        setTimeout(() => { input.classList.remove('wrong'); document.body.classList.remove('screen-shake'); input.value = ''; }, 1500);
      }
    }

    // â•â•â• SEA CANVAS ANIMATION â•â•â•
    const seaCanvas = document.getElementById('sea-canvas');
    const seaCtx = seaCanvas.getContext('2d');

    function initSea() {
      seaCanvas.width = seaCanvas.parentElement.clientWidth;
      seaCanvas.height = 180;
      let time = 0;

      function drawSea() {
        time += 0.02;
        if (seaSplit && splitProgress < 1) splitProgress = Math.min(1, splitProgress + 0.008);

        seaCtx.clearRect(0, 0, seaCanvas.width, seaCanvas.height);
        const grad = seaCtx.createLinearGradient(0, 0, 0, seaCanvas.height);
        grad.addColorStop(0, `rgba(0,${40+splitProgress*60},${80+splitProgress*80},0.8)`);
        grad.addColorStop(1, `rgba(0,${20+splitProgress*30},${60+splitProgress*60},0.9)`);
        seaCtx.fillStyle = grad;
        seaCtx.fillRect(0, 0, seaCanvas.width, seaCanvas.height);

        if (splitProgress > 0) {
          const pathWidth = splitProgress * 80;
          const pathX = seaCanvas.width/2 - pathWidth/2;
          const pathGrad = seaCtx.createLinearGradient(0, 60, 0, seaCanvas.height);
          pathGrad.addColorStop(0, `rgba(210,180,100,${splitProgress*0.7})`);
          pathGrad.addColorStop(1, `rgba(180,150,80,${splitProgress*0.5})`);
          seaCtx.fillStyle = pathGrad;
          seaCtx.fillRect(pathX, 60, pathWidth, seaCanvas.height-60);
        }

        for (let layer = 0; layer < 3; layer++) {
          const halfW = splitProgress * 40 + layer * 10;
          seaCtx.beginPath();
          seaCtx.moveTo(0, seaCanvas.height);
          for (let x = 0; x <= seaCanvas.width/2 - halfW; x += 5) {
            const y = 40 + layer*25 + Math.sin(x*0.02+time+layer)*15 + Math.sin(x*0.01+time*0.7)*10;
            seaCtx.lineTo(x, y);
          }
          const wallH = 40 + layer*25 - splitProgress*30;
          seaCtx.lineTo(seaCanvas.width/2-halfW, wallH);
          seaCtx.lineTo(seaCanvas.width/2-halfW, seaCanvas.height);
          seaCtx.closePath();
          seaCtx.fillStyle = [`rgba(0,${100+splitProgress*40},200,0.5)`,`rgba(0,${80+splitProgress*30},180,0.4)`,`rgba(0,${60+splitProgress*20},150,0.3)`][layer];
          seaCtx.fill();

          seaCtx.beginPath();
          seaCtx.moveTo(seaCanvas.width, seaCanvas.height);
          for (let x = seaCanvas.width; x >= seaCanvas.width/2+halfW; x -= 5) {
            const y = 40 + layer*25 + Math.sin(x*0.02-time+layer)*15 + Math.sin(x*0.01-time*0.7)*10;
            seaCtx.lineTo(x, y);
          }
          seaCtx.lineTo(seaCanvas.width/2+halfW, wallH);
          seaCtx.lineTo(seaCanvas.width/2+halfW, seaCanvas.height);
          seaCtx.closePath();
          seaCtx.fillStyle = [`rgba(0,${100+splitProgress*40},200,0.5)`,`rgba(0,${80+splitProgress*30},180,0.4)`,`rgba(0,${60+splitProgress*20},150,0.3)`][layer];
          seaCtx.fill();
        }

        if (splitProgress > 0.85) {
          const alpha = (splitProgress-0.85)/0.15;
          seaCtx.globalAlpha = alpha;
          seaCtx.font = '14px serif'; seaCtx.textAlign = 'center';
          [0.2,0.4,0.6,0.8].forEach(pos => {
            seaCtx.fillText('ğŸš¶', seaCanvas.width/2-10, 80+pos*(seaCanvas.height-90));
          });
          seaCtx.globalAlpha = 1; seaCtx.textAlign = 'start';
        }
        requestAnimationFrame(drawSea);
      }
      drawSea();
    }
    initSea();

    // â•â•â• PHASE 2: Drag & Drop Verse â•â•â•
    const realPieces = [
      { text: '×•×™×§×—', slot: 0 },
      { text: '×©×© ×××•×ª', slot: 1, highlight: true },
      { text: '×¨×›×‘', slot: 2 },
      { text: '×‘×—×•×¨', slot: 3 },
      { text: '×•×›×œ ×¨×›×‘ ××¦×¨×™×', slot: 4 }
    ];
    const fakePieces = [
      { text: '×•×™×¡×¢ ×¤×¨×¢×”', slot: -1 },
      { text: '×‘×—×™×œ ×’×“×•×œ', slot: -1 },
      { text: '××¨×›×‘×•×ª ×–×”×‘', slot: -1 }
    ];

    const allPieces = [...realPieces.map(p => ({...p, real: true})), ...fakePieces.map(p => ({...p, real: false}))];
    // Shuffle
    for (let i = allPieces.length-1; i > 0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [allPieces[i], allPieces[j]] = [allPieces[j], allPieces[i]];
    }

    let draggedPiece = null;
    const piecesContainer = document.getElementById('drag-pieces');

    allPieces.forEach((piece, idx) => {
      const el = document.createElement('div');
      el.className = 'drag-piece' + (piece.real ? '' : ' fake-piece');
      el.textContent = piece.text;
      el.draggable = true;
      el.dataset.idx = idx;

      el.addEventListener('dragstart', (e) => {
        draggedPiece = { el, piece, idx };
        el.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      el.addEventListener('dragend', () => { el.classList.remove('dragging'); });

      // Touch support
      el.addEventListener('touchstart', (e) => {
        draggedPiece = { el, piece, idx };
        el.classList.add('dragging');
      });

      piecesContainer.appendChild(el);
    });

    // Drop zones
    document.querySelectorAll('.drop-zone').forEach(zone => {
      zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        handleDrop(zone);
      });

      // Touch drop â€” simplified
      zone.addEventListener('touchend', (e) => {
        if (draggedPiece) handleDrop(zone);
      });
    });

    // Also handle touch move to allow "dragging" feel
    document.addEventListener('touchend', () => {
      if (draggedPiece) draggedPiece.el.classList.remove('dragging');
      draggedPiece = null;
    });

    function handleDrop(zone) {
      if (!draggedPiece || zone.classList.contains('filled')) return;
      const { el, piece } = draggedPiece;
      const slotIdx = parseInt(zone.dataset.slot);

      if (!piece.real) {
        // FAKE piece â€” red flash
        el.style.borderColor = 'rgba(255,50,50,0.6)';
        el.style.background = 'rgba(100,0,0,0.2)';
        el.style.color = '#ff6666';
        el.style.opacity = '0.3';
        el.draggable = false;
        el.classList.add('placed');
        document.body.classList.add('screen-shake');
        const flash = document.querySelector('.red-flash');
        flash.classList.remove('active'); void flash.offsetWidth; flash.classList.add('active');
        setTimeout(() => document.body.classList.remove('screen-shake'), 600);
        const errors = parseInt(localStorage.getItem(GAME.STORAGE_PREFIX+'Errors')||'0')+1;
        localStorage.setItem(GAME.STORAGE_PREFIX+'Errors', errors.toString());
        return;
      }

      if (piece.slot === slotIdx) {
        // CORRECT slot
        zone.textContent = piece.text;
        zone.classList.add('filled');
        if (piece.highlight) zone.classList.add('highlight-slot');
        el.classList.add('placed');
        placedCount++;
        document.getElementById('placed-count').textContent = placedCount;

        if (placedCount === 5) {
          setTimeout(() => {
            document.getElementById('hard-question').classList.add('unlocked');
          }, 600);
        }
      } else {
        // Wrong slot â€” shake
        zone.classList.add('drag-over');
        setTimeout(() => zone.classList.remove('drag-over'), 300);
        document.body.classList.add('screen-shake');
        setTimeout(() => document.body.classList.remove('screen-shake'), 400);
      }

      draggedPiece.el.classList.remove('dragging');
      draggedPiece = null;
    }

    // â•â•â• PHASE 3: Hard Question â•â•â•
    function answerHQ(el, isCorrect) {
      if (phase3Done) return;
      document.querySelectorAll('.hq-option').forEach(o => o.classList.add('picked'));
      el.classList.add(isCorrect ? 'correct-pick' : 'wrong-pick');

      if (isCorrect) {
        phase3Done = true;
        setTimeout(() => document.querySelector('.password-input').focus(), 600);
      } else {
        document.body.classList.add('screen-shake');
        const flash = document.querySelector('.red-flash');
        flash.classList.remove('active'); void flash.offsetWidth; flash.classList.add('active');
        setTimeout(() => document.body.classList.remove('screen-shake'), 600);
        const errors = parseInt(localStorage.getItem(GAME.STORAGE_PREFIX+'Errors')||'0')+1;
        localStorage.setItem(GAME.STORAGE_PREFIX+'Errors', errors.toString());
        setTimeout(() => {
          document.querySelectorAll('.hq-option').forEach(o => o.classList.remove('picked','wrong-pick'));
        }, 1200);
      }
    }
  </script>
</body>
</html>
