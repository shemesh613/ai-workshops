<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×—×“×¨ 1 â€” ××›×•×ª ××¦×¨×™×</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* â”€â”€ Scratch Card â”€â”€ */
    .scratch-container {
      position: relative; margin: 15px 0; border-radius: 12px;
      overflow: hidden; border: 1px solid rgba(200,80,80,0.3);
      background: rgba(40,10,10,0.3);
    }
    .scratch-hidden-text {
      padding: 25px 20px; text-align: center; direction: rtl;
      font-family: 'Frank Ruhl Libre', serif; line-height: 2;
      font-size: 1.05rem; color: rgba(255,255,255,0.85);
      min-height: 120px; display: flex; align-items: center; justify-content: center;
    }
    .scratch-hidden-text strong { color: #ffd700; font-size: 1.3rem; }
    .scratch-canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Ctext y='18' font-size='18'%3EğŸª™%3C/text%3E%3C/svg%3E") 12 12, crosshair;
      border-radius: 12px;
    }
    .scratch-progress {
      text-align: center; font-size: 0.75rem; color: rgba(255,100,100,0.4); margin: 3px 0;
    }

    /* â”€â”€ Filter Puzzle â”€â”€ */
    .filter-puzzle {
      margin: 15px 0; padding: 18px; border-radius: 12px;
      border: 1px solid rgba(200,80,80,0.2); background: rgba(30,10,10,0.3);
      display: none;
    }
    .filter-puzzle.unlocked { display: block; animation: scrollReveal 0.8s ease-out; }
    .filter-text {
      font-family: 'Frank Ruhl Libre', serif; font-size: 1.1rem;
      line-height: 2.2; color: rgba(255,255,255,0.85); padding: 20px;
      direction: rtl; transition: filter 0.3s; text-align: center;
      background: rgba(0,0,0,0.3); border-radius: 10px; margin: 10px 0;
    }
    .filter-sliders { display: flex; flex-direction: column; gap: 10px; margin: 12px 0; }
    .slider-row {
      display: flex; align-items: center; gap: 10px; font-size: 0.8rem;
      color: rgba(255,150,100,0.6);
    }
    .slider-row label { min-width: 60px; text-align: left; font-family: 'Secular One', sans-serif; }
    .slider-row input[type="range"] { flex: 1; accent-color: #ff6644; }
    .slider-row .val { min-width: 35px; text-align: center; color: rgba(255,200,150,0.7); }

    /* â”€â”€ Hard Question â”€â”€ */
    .hard-question {
      margin: 15px 0; padding: 18px; border-radius: 12px;
      border: 1px solid rgba(255,215,0,0.2); background: rgba(50,30,0,0.2);
      display: none; text-align: center;
    }
    .hard-question.unlocked { display: block; animation: scrollReveal 0.8s ease-out; }
    .hq-text { font-size: 1.1rem; color: #fff; margin-bottom: 12px; line-height: 1.6; }
    .hq-options {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 10px 0;
    }
    .hq-option {
      padding: 12px; border-radius: 10px; cursor: pointer;
      background: rgba(255,215,0,0.05); border: 2px solid rgba(255,215,0,0.15);
      color: rgba(255,255,255,0.7); font-size: 0.9rem; transition: all 0.3s;
      font-family: 'Frank Ruhl Libre', serif;
    }
    .hq-option:hover:not(.picked) { background: rgba(255,215,0,0.12); border-color: rgba(255,215,0,0.35); transform: translateY(-2px); }
    .hq-option.picked { pointer-events: none; }
    .hq-option.correct-pick { border-color: rgba(0,255,100,0.5) !important; background: rgba(0,100,0,0.2) !important; color: #00ff88; }
    .hq-option.wrong-pick { border-color: rgba(255,50,50,0.5) !important; background: rgba(100,0,0,0.2) !important; color: #ff6666; opacity: 0.5; }

    /* â”€â”€ Verse Reveal â”€â”€ */
    .verse-reveal {
      display: none; margin: 15px 0; padding: 18px;
      background: rgba(80,30,0,0.3); border: 1px solid rgba(255,150,50,0.3);
      border-radius: 12px; text-align: center;
    }
    .verse-reveal.visible { display: block; animation: scrollReveal 0.8s ease-out; }

    .screen-shake { animation: screenShake 0.6s ease-out; }
    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      10% { transform: translateX(-8px); } 20% { transform: translateX(8px); }
      30% { transform: translateX(-6px); } 40% { transform: translateX(6px); }
    }
    @keyframes scrollReveal { from { opacity:0; transform:scaleY(0.3); } to { opacity:1; transform:scaleY(1); } }
    @media (max-width: 600px) {
      .hq-options { grid-template-columns: 1fr; }
      .filter-text { font-size: 0.9rem; padding: 15px; }
    }
  </style>
</head>
<body class="theme-plague">
  <video class="video-bg" autoplay muted loop playsinline
    poster="https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1920&q=80">
    <source src="https://cdn.coverr.co/videos/coverr-red-ink-in-water-1549/1080p.mp4" type="video/mp4">
  </video>
  <div class="fog-overlay"></div>
  <div class="dark-overlay"></div>
  <canvas id="particles-canvas"></canvas>

  <div class="timer-bar">
    <span class="room-indicator">ğŸ©¸ ×—×“×¨ 1 â€” ××›×•×ª ××¦×¨×™×</span>
    <span class="timer-display" id="timer-display">00:00</span>
  </div>

  <div class="room-container">
    <div class="room-icon">ğŸ©¸</div>
    <h1 class="room-title">××›×•×ª ××¦×¨×™×</h1>
    <p class="room-subtitle">××’×™×œ×” ×¢×ª×™×§×” × ××¦××” ×‘×—×•×œ×•×ª ××¦×¨×™×. ×’×¨×“ ××ª ×”××‘×§ â€” ×•×—×©×•×£ ××ª ×”×¡×•×“.</p>

    <div class="question-box">
      <p class="question-text">×›××” ×©× ×” ×™×©×‘×• ×‘× ×™ ×™×©×¨××œ ×‘××¦×¨×™×?</p>
      <p style="font-size: 0.85rem; color: rgba(255,150,150,0.5); margin-top: 8px;">
        ğŸª™ ×©×œ×‘ 1: ×’×¨×“ ××ª ×”××’×™×œ×”. ×©×œ×‘ 2: ×¤×¢× ×— ××ª ×”×˜×§×¡×˜ ×”××˜×•×©×˜×©. ×©×œ×‘ 3: ×¢× ×” ×¢×œ ×©××œ×ª ×”×‘×•× ×•×¡.
      </p>
    </div>

    <!-- â•â•â• PHASE 1: Scratch Card â•â•â• -->
    <p style="font-size:0.85rem; color:rgba(255,100,100,0.5); text-align:center; margin:8px 0;">
      ğŸª™ ×’×¨×“ ×¢× ×”×¢×›×‘×¨ (××• ×”××¦×‘×¢) ×›×“×™ ×œ×—×©×•×£ ××ª ×”××’×™×œ×”:
    </p>
    <div class="scratch-container" id="scratch-container">
      <div class="scratch-hidden-text">
        "×•Ö¼××•Ö¹×©Ö·××‘ ×‘Ö°Ö¼× Öµ×™ ×™Ö´×©Ö°×‚×¨Ö¸×Öµ×œ ×Ö²×©Ö¶××¨ ×™Ö¸×©Ö°××‘×•Ö¼ ×‘Ö°Ö¼×Ö´×¦Ö°×¨Ö¸×™Ö´× â€”<br>
        <strong>×©Ö°××œÖ¹×©Ö´××™× ×©Ö¸×× Ö¸×” ×•Ö°×Ö·×¨Ö°×‘Ö·Ö¼×¢ ×Öµ××•Ö¹×ª</strong> ×©Ö¸×× Ö¸×”"<br>
        <span style="font-size:0.75rem; color:rgba(255,215,0,0.5);">×©××•×ª ×™"×‘:×'</span>
      </div>
      <canvas class="scratch-canvas" id="scratch-canvas"></canvas>
    </div>
    <div class="scratch-progress">×’×¨×“×ª: <span id="scratch-percent">0</span>%</div>

    <!-- â•â•â• PHASE 2: Filter Puzzle â•â•â• -->
    <div class="filter-puzzle" id="filter-puzzle">
      <p style="color: #ff8844; font-size: 0.95rem; margin-bottom: 10px;">ğŸ” ××’×™×œ×” ×©× ×™×™×” × ××¦××” â€” ××‘×œ ×”×™× ××˜×•×©×˜×©×ª! ×›×•×•×Ÿ ××ª ×”×¡×œ×™×™×“×¨×™×:</p>
      <div class="filter-text" id="filter-text">
        "×•Ö·×™Ö¹Ö¼××Ö¶×¨ ×”' ×Ö¶×œ ×Ö¹×©Ö¶××”: ×‘Ö¹Ö¼× ×Ö¶×œ ×¤Ö·Ö¼×¨Ö°×¢Ö¹×” â€” ×›Ö´Ö¼×™ ×Ö²× Ö´×™ ×”Ö´×›Ö°×‘Ö·Ö¼×“Ö°×ªÖ´Ö¼×™ ×Ö¶×ª ×œÖ´×‘Ö¼×•Ö¹
        ×•Ö°×Ö¶×ª ×œÖµ×‘ ×¢Ö²×‘Ö¸×“Ö¸×™×•, ×œÖ°×Ö·×¢Ö·×Ÿ ×©Ö´××ªÖ´×™ ×Ö¹×ªÖ¹×ªÖ·×™ ×Öµ×œÖ¶Ö¼×” ×‘Ö°Ö¼×§Ö´×¨Ö°×‘Ö¼×•Ö¹."
        <br><span style="font-size:0.75rem; color:rgba(255,215,0,0.5);">×©××•×ª ×™':×'</span>
      </div>
      <div class="filter-sliders">
        <div class="slider-row">
          <label>×˜×©×˜×•×©:</label>
          <input type="range" id="blur-slider" min="0" max="20" value="15">
          <span class="val" id="blur-val">15</span>
        </div>
        <div class="slider-row">
          <label>× ×™×’×•×“×™×•×ª:</label>
          <input type="range" id="contrast-slider" min="20" max="200" value="40">
          <span class="val" id="contrast-val">40</span>
        </div>
        <div class="slider-row">
          <label>×¦×‘×¢:</label>
          <input type="range" id="hue-slider" min="0" max="360" value="180">
          <span class="val" id="hue-val">180</span>
        </div>
      </div>
    </div>

    <!-- â•â•â• PHASE 3: Hard Question â•â•â• -->
    <div class="hard-question" id="hard-question">
      <p style="color:#ffd700; font-size:0.85rem; margin-bottom:8px;">âš¡ ×©××œ×ª ×‘×•× ×•×¡ â€” ×¨××ª ×—×™×“×•×Ÿ ×”×ª× "×š:</p>
      <p class="hq-text">×›××” ×™××™× × ××©×›×” ××›×ª ×”×“×?</p>
      <p style="font-size:0.75rem; color:rgba(255,255,255,0.35); margin-bottom:10px;">×¨××–: "×•Ö·×™Ö´Ö¼×Ö¸Ö¼×œÖµ× ×©Ö´××‘Ö°×¢Ö·×ª ×™Ö¸×Ö´×™× ×Ö·×—Ö²×¨Öµ×™ ×”Ö·×›Ö¼×•Ö¹×ª ×”' ×Ö¶×ª ×”Ö·×™Ö°×Ö¹×¨" â€” ×©××•×ª ×–':×›"×”</p>
      <div class="hq-options">
        <div class="hq-option" onclick="answerHQ(this, false)">3 ×™××™×</div>
        <div class="hq-option" onclick="answerHQ(this, true)">7 ×™××™×</div>
        <div class="hq-option" onclick="answerHQ(this, false)">10 ×™××™×</div>
        <div class="hq-option" onclick="answerHQ(this, false)">40 ×™××™×</div>
      </div>
    </div>

    <!-- â•â•â• Final Verse Reveal â•â•â• -->
    <div class="verse-reveal" id="verse-reveal">
      <p style="color: #ff8844; font-size: 1rem; margin-bottom: 8px;">ğŸ“œ ×©×œ×•×©×ª ×”×©×œ×‘×™× ×”×•×©×œ××•!</p>
      <p style="color: rgba(255,255,255,0.8); line-height: 1.8; font-size: 1rem;">
        "×•××•×©×‘ ×‘× ×™ ×™×©×¨××œ ××©×¨ ×™×©×‘×• ×‘××¦×¨×™× â€”<br>
        <strong style="color: #ffd700; font-size: 1.3rem;">×©×œ×•×©×™× ×©× ×” ×•××¨×‘×¢ ×××•×ª</strong> ×©× ×”"
      </p>
      <p style="font-size: 0.8rem; color: rgba(255,215,0,0.5); margin-top: 8px;">×›××” ×–×” ×‘×¡×¤×¨×•×ª? 30 + 400 = ?</p>
    </div>

    <a href="https://www.sefaria.org/Exodus.12.40?lang=he" target="_blank" class="sefaria-link" style="margin:5px auto; display:inline-flex;">
      ğŸ“– ×©××•×ª ×™"×‘:×' â€” ×¡×¤×¨×™×
    </a>

    <div class="password-section">
      <div class="password-wrapper">
        <input type="text" class="password-input" placeholder="×”××¡×¤×¨ ××”×¤×¡×•×§..." inputmode="numeric" autocomplete="off">
        <button class="submit-btn">ğŸ”“ ×¤×ª×—</button>
      </div>
      <div class="attempts-display"></div>
      <div class="hint-box">ğŸ’¡ ×’×¨×“ ××ª ×”××’×™×œ×” â† ×¤×¢× ×— ××ª ×”×˜×©×˜×•×© â† ×¢× ×” ×¢×œ ×©××œ×ª ×”×‘×•× ×•×¡.</div>
      <div class="hint-box strong">ğŸ”¥ ×©×œ×•×©×™× + ××¨×‘×¢ ×××•×ª = ? ×¨×©×•× ×‘×¡×¤×¨×•×ª.</div>
    </div>
  </div>

  <div class="red-flash"></div>
  <div class="success-overlay">
    <div class="success-message">ğŸ©¸ ×”××›×•×ª ×¤×¡×§×•!</div>
    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px; font-size: 1.1rem;">×¤×¨×¢×” × ×›× ×¢. ××‘×œ ×”×“×¨×š ××¨×•×›×” â€” ×”×™× ××—×›×”.</p>
    <a href="room2.html" class="next-room-btn">â†’ ××œ ×™× ×¡×•×£ ğŸŒŠ</a>
  </div>

  <script src="particles.js"></script>
  <script src="game.js"></script>
  <script>
    if (!checkRoomAccess(1)) throw 'Access denied';
    new ParticleEngine('particles-canvas', 'fire');
    const timer = new GameTimer();
    const checker = new PasswordChecker('room1', 'room2.html');

    let phase1Done = false, phase2Done = false, phase3Done = false;

    // â•â•â• PHASE 1: Scratch Card â•â•â•
    const scratchCanvas = document.getElementById('scratch-canvas');
    const scratchCtx = scratchCanvas.getContext('2d');
    let isScratching = false;

    function initScratch() {
      const container = document.getElementById('scratch-container');
      scratchCanvas.width = container.offsetWidth;
      scratchCanvas.height = container.offsetHeight;

      const grad = scratchCtx.createLinearGradient(0, 0, scratchCanvas.width, scratchCanvas.height);
      grad.addColorStop(0, '#5a3a1a'); grad.addColorStop(0.3, '#6b4a2a');
      grad.addColorStop(0.6, '#4a2a0a'); grad.addColorStop(1, '#3a1a00');
      scratchCtx.fillStyle = grad;
      scratchCtx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);

      for (let i = 0; i < 3000; i++) {
        scratchCtx.fillStyle = `rgba(${Math.random()>0.5?255:0},${Math.random()>0.5?200:0},${Math.random()>0.5?100:0},${Math.random()*0.08})`;
        scratchCtx.fillRect(Math.random()*scratchCanvas.width, Math.random()*scratchCanvas.height, 2, 2);
      }

      scratchCtx.fillStyle = 'rgba(255,215,100,0.4)';
      scratchCtx.font = '18px "Frank Ruhl Libre", serif';
      scratchCtx.textAlign = 'center';
      scratchCtx.fillText('ğŸª™ ×’×¨×“ ×›××Ÿ ×œ×—×©×•×£ ××ª ×”××’×™×œ×”', scratchCanvas.width/2, scratchCanvas.height/2-10);
      scratchCtx.font = '14px "Frank Ruhl Libre", serif';
      scratchCtx.fillStyle = 'rgba(255,200,100,0.25)';
      scratchCtx.fillText('××’×™×œ×ª ×™×¦×™××ª ××¦×¨×™×', scratchCanvas.width/2, scratchCanvas.height/2+20);
    }

    function scratch(x, y) {
      scratchCtx.globalCompositeOperation = 'destination-out';
      scratchCtx.beginPath();
      scratchCtx.arc(x, y, 22, 0, Math.PI * 2);
      scratchCtx.fill();
      scratchCtx.globalCompositeOperation = 'source-over';
    }

    function checkScratchProgress() {
      const imageData = scratchCtx.getImageData(0, 0, scratchCanvas.width, scratchCanvas.height);
      let transparent = 0;
      const total = scratchCanvas.width * scratchCanvas.height;
      for (let i = 3; i < imageData.data.length; i += 4) {
        if (imageData.data[i] < 128) transparent++;
      }
      const percent = Math.floor((transparent / total) * 100);
      document.getElementById('scratch-percent').textContent = percent;

      if (percent >= 40 && !phase1Done) {
        phase1Done = true;
        scratchCanvas.style.transition = 'opacity 0.5s';
        scratchCanvas.style.opacity = '0';
        setTimeout(() => {
          scratchCanvas.style.display = 'none';
          document.getElementById('filter-puzzle').classList.add('unlocked');
        }, 500);
      }
    }

    scratchCanvas.addEventListener('mousedown', () => { isScratching = true; });
    scratchCanvas.addEventListener('mouseup', () => { isScratching = false; checkScratchProgress(); });
    scratchCanvas.addEventListener('mouseleave', () => { isScratching = false; });
    scratchCanvas.addEventListener('mousemove', (e) => {
      if (!isScratching) return;
      const rect = scratchCanvas.getBoundingClientRect();
      scratch(e.clientX - rect.left, e.clientY - rect.top);
    });
    scratchCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); isScratching = true; });
    scratchCanvas.addEventListener('touchend', () => { isScratching = false; checkScratchProgress(); });
    scratchCanvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = scratchCanvas.getBoundingClientRect();
      scratch(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    initScratch();

    // â•â•â• PHASE 2: CSS Filter Puzzle â•â•â•
    const filterText = document.getElementById('filter-text');
    const blurSlider = document.getElementById('blur-slider');
    const contrastSlider = document.getElementById('contrast-slider');
    const hueSlider = document.getElementById('hue-slider');

    filterText.style.filter = 'blur(15px) contrast(0.4) hue-rotate(180deg)';

    function updateFilters() {
      const b = blurSlider.value, c = contrastSlider.value, h = hueSlider.value;
      document.getElementById('blur-val').textContent = b;
      document.getElementById('contrast-val').textContent = c;
      document.getElementById('hue-val').textContent = h;
      filterText.style.filter = `blur(${b}px) contrast(${c/100}) hue-rotate(${h}deg)`;

      if (parseInt(b) <= 2 && parseInt(c) >= 80 && (parseInt(h) <= 30 || parseInt(h) >= 330) && !phase2Done) {
        phase2Done = true;
        filterText.style.filter = 'none';
        filterText.style.textShadow = '0 0 10px rgba(255,215,0,0.3)';
        setTimeout(() => document.getElementById('hard-question').classList.add('unlocked'), 500);
      }
    }

    [blurSlider, contrastSlider, hueSlider].forEach(s => s.addEventListener('input', updateFilters));

    // â•â•â• PHASE 3: Hard Question â•â•â•
    function answerHQ(el, isCorrect) {
      if (phase3Done) return;
      document.querySelectorAll('.hq-option').forEach(o => o.classList.add('picked'));
      el.classList.add(isCorrect ? 'correct-pick' : 'wrong-pick');

      if (isCorrect) {
        phase3Done = true;
        setTimeout(() => {
          document.getElementById('verse-reveal').classList.add('visible');
          document.querySelector('.password-input').focus();
        }, 600);
      } else {
        document.body.classList.add('screen-shake');
        const flash = document.querySelector('.red-flash');
        flash.classList.remove('active'); void flash.offsetWidth; flash.classList.add('active');
        setTimeout(() => document.body.classList.remove('screen-shake'), 600);
        const errors = parseInt(localStorage.getItem(GAME.STORAGE_PREFIX + 'Errors') || '0') + 1;
        localStorage.setItem(GAME.STORAGE_PREFIX + 'Errors', errors.toString());
        setTimeout(() => {
          document.querySelectorAll('.hq-option').forEach(o => o.classList.remove('picked', 'wrong-pick'));
        }, 1200);
      }
    }
  </script>
</body>
</html>
